suite: Traefik configuration
templates:
  - deployment.yaml
  - service.yaml
tests:
  - it: should have port 8000 of pod published to 80 of service by default, and defined as entrypoint "web"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: web
            containerPort: 8000
            protocol: TCP
        template: deployment.yaml
      - contains:
          path: spec.ports
          content:
            name: web
            port: 80
            protocol: TCP
            targetPort: web
        template: service.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.web.address=:8000/tcp"
        template: deployment.yaml
  - it: should have port 8443 of pod published to 443 of service by default, and defined as entrypoint "websecure"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: websecure
            containerPort: 8443
            protocol: TCP
        template: deployment.yaml
      - contains:
          path: spec.ports
          content:
            name: websecure
            port: 443
            protocol: TCP
            targetPort: websecure
        template: service.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.address=:8443/tcp"
        template: deployment.yaml
  - it: should have port 9000 of pod exposed for probes but NOT published to the service by default
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: traefik
            containerPort: 9000
            protocol: TCP
        template: deployment.yaml
      - notContains:
          path: spec.ports
          content:
            name: traefik
            port: 9000
            targetPort: traefik
        template: service.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.traefik.address=:9000/tcp"
        template: deployment.yaml
  - it: should have a custom port when specified via values
    set:
      ports:
        ssh:
          port: 22
          expose: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: ssh
            containerPort: 22
            protocol: TCP
        template: deployment.yaml
      - contains:
          path: spec.ports
          content:
            name: ssh
            port: 22
            protocol: TCP
            targetPort: ssh
        template: service.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.ssh.address=:22/tcp"
        template: deployment.yaml
  - it: should have a hostPort when specified via values
    set:
      ports:
        ssh:
          port: 22
          expose: true
          hostPort: 22
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: ssh
            containerPort: 22
            hostPort: 22
            protocol: TCP
        template: deployment.yaml
      - contains:
          path: spec.ports
          content:
            name: ssh
            port: 22
            protocol: TCP
            targetPort: ssh
        template: service.yaml
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.ssh.address=:22/tcp"
        template: deployment.yaml
  - it: should have a UDP custom port when specified via values
    set:
      ports:
        udp:
          port: 51
          expose: true
          protocol: UDP
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: udp
            containerPort: 51
            protocol: UDP
        template: deployment.yaml
      - contains:
          path: spec.ports
          content:
            name: udp
            port: 51
            protocol: UDP
            targetPort: udp
        template: service.yaml
        documentIndex: 0
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.udp.address=:51/udp"
        template: deployment.yaml

  - it: should set entrypoint to default when configured
    template: deployment.yaml
    set:
      experimental:
        v3:
          enabled: true
      ports:
        web:
          asDefault: true
        websecure:
          asDefault: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.web.asDefault=true"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.asDefault=false"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--entrypoints.websecure.asDefault=true"

  - it: should throw and error when default entrypoint is enabled without traefik v3
    template: deployment.yaml
    set:
      experimental:
        v3:
          enabled: false
      ports:
        web:
          asDefault: true
        websecure:
          asDefault: false
    asserts:
      - failedTemplate:
          errorMessage: "Default entrypoints are only available on Traefik v3. Please set `experimental.v3.enabled` to true and update `image.tag` to `v3.0`."
